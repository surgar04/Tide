//! Licensed to the .NET Foundation under one or more agreements.
//! The .NET Foundation licenses this file to you under the MIT license.
let e=!1,t=null,s=null,n=null,o=null;const r=[65,68,86,82,95,86,49,0],i=[68,79,84,78,69,84,95,73,80,67,95,86,49,0];function a(e){return Uint8Array.from([...g(2,1,p(8)),...m(e)])}function c(e){const t=function(e){let t=0;t+=4,t+=4,t+=1,t+=4;for(const s of e.providers)t+=8,t+=4,t+=h(s.provider_name),t+=h(s.arguments);return t}(e),s=[...g(2,3,p(t)),...d(e.circularBufferMB),...d(e.format),...l(e.requestRundown?1:0),...d(e.providers.length)];for(const t of e.providers)s.push(...m(t.keywords)),s.push(...d(t.logLevel)),s.push(...f(t.provider_name)),s.push(...f(t.arguments));return Uint8Array.from(s)}function l(e){return Uint8Array.from([e])}function u(e){return new Uint8Array(Uint16Array.from([e]).buffer)}function d(e){return new Uint8Array(Uint32Array.from([e]).buffer)}function m(e){return new Uint8Array(Uint32Array.from([e[1],e[0]]).buffer)}function f(e){const t=[];if(null==e||""===e)t.push(...d(1)),t.push(...u(0));else{const s=e.length,n="\0"===e[s-1];t.push(...d(s+(n?0:1)));for(let n=0;n<s;n++)t.push(...u(e.charCodeAt(n)));n||t.push(...u(0))}return t}function h(e){return null==e||""===e?6:4+2*e.length+2}function p(e){return 20+e}function g(e,t,s){return Uint8Array.from([...Uint8Array.from(i),...u(s),...l(e),...l(t),...u(0)])}const v="MONO_WASM: ";function w(e,...t){console.warn(v+e,...t)}let _,S;function y(){if(_=void 0,n.is_runtime_running())try{s.mono_background_exec(),s.mono_wasm_ds_exec(),C(100)}catch(e){n.mono_exit(1,e)}}function C(e=0){_&&0!==e||(_=o.safeSetTimeout(y,e))}class b{constructor(e){this.client_socket=e,this.messagesToSend=[],this.messagesReceived=[]}store(e){return this.messagesToSend.push(e),e.byteLength}poll(){return this.messagesReceived.length}recv(e,t){if(0===this.messagesReceived.length)return 0;const s=this.messagesReceived[0],n=Math.min(s.length,t);return o.HEAPU8.set(s.subarray(0,n),e),n===s.length?this.messagesReceived.shift():this.messagesReceived[0]=s.subarray(n),n}}function k(e){if(e||(e={}),!E)throw new Error("No active JS diagnostic session");if(!s.config.environmentVariables.DOTNET_WasmPerformanceInstrumentation)throw new Error("method instrumentation is not enabled, please enable it with WasmPerformanceInstrumentation MSBuild property");const t=n.createPromiseController();return B({onClosePromise:t.promise_control,skipDownload:e.skipDownload,commandOnAdvertise:()=>function(e){return c({circularBufferMB:e.circularBufferMB||256,format:1,requestRundown:!0,providers:[{keywords:[0,0],logLevel:4,provider_name:"Microsoft-DotNETCore-SampleProfiler",arguments:null},...e.extraProviders||[]]})}(e),onSessionStart:function(t){var s;o.safeSetTimeout((()=>{t.sendCommand(a(t.session_id))}),1e3*(null!==(s=null==e?void 0:e.durationSeconds)&&void 0!==s?s:60))}}),t.promise}function A(e){if(e||(e={}),!E)throw new Error("No active JS diagnostic session");const t=n.createPromiseController();return B({onClosePromise:t.promise_control,skipDownload:e.skipDownload,commandOnAdvertise:()=>function(e){return c({circularBufferMB:e.circularBufferMB||256,format:1,requestRundown:!1,providers:[{keywords:[0,2],logLevel:4,provider_name:"System.Diagnostics.Metrics",arguments:`SessionId=SHARED;Metrics=System.Runtime;RefreshInterval=${e.intervalSeconds||1};MaxTimeSeries=1000;MaxHistograms=10;ClientId=${"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(+e^globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>+e/4).toString(16)))};`},...e.extraProviders||[]]})}(e),onSessionStart:function(t){var s;o.safeSetTimeout((()=>{t.sendCommand(a(t.session_id))}),1e3*(null!==(s=null==e?void 0:e.durationSeconds)&&void 0!==s?s:60))}}),t.promise}function D(e){if(e||(e={}),!E)throw new Error("No active JS diagnostic session");const t=n.createPromiseController();let s=0,r=!1;return B({onClosePromise:t.promise_control,skipDownload:e.skipDownload,commandOnAdvertise:()=>function(e){return c({circularBufferMB:e.circularBufferMB||256,format:1,requestRundown:!0,providers:[{keywords:[0,26738689],logLevel:5,provider_name:"Microsoft-Windows-DotNETRuntime",arguments:null},...e.extraProviders||[]]})}(e),onData:function(t,n){var i;t.store(n),r||(s&&clearTimeout(s),s=o.safeSetTimeout((()=>{r=!0,t.sendCommand(a(t.session_id))}),1e3*(null!==(i=null==e?void 0:e.durationSeconds)&&void 0!==i?i:1)))}}),t.promise}let E,T,R=!1;class M extends b{constructor(e){super(e),this.client_socket=e,this.session_id=void 0,this.stopDelayedAfterLastMessage=void 0,this.resumedRuntime=!1}sendCommand(e){E?E.respond(e):w("no server yet")}async connectNewClient(){this.diagClient=await S.promise,U();const e=this.diagClient.commandOnAdvertise();this.respond(e)}is_advert_message(e){return r.every(((t,s)=>t===e[s]))}is_response_message(e){return i.every(((t,s)=>t===e[s]))&&255==e[16]}is_response_ok_with_session(e){return 28===e.byteLength&&0==e[17]}parse_session_id(e){const t=e.subarray(20,28),s=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[t[4]|t[5]<<8|t[6]<<16|t[7]<<24,s]}send(e){var t,s,n;return C(),this.is_advert_message(e)?(E=this,this.connectNewClient()):this.is_response_message(e)?this.is_response_ok_with_session(e)?(this.session_id=this.parse_session_id(e),(null===(t=this.diagClient)||void 0===t?void 0:t.onSessionStart)&&this.diagClient.onSessionStart(this)):(null===(s=this.diagClient)||void 0===s?void 0:s.onError)?this.diagClient.onError(this,e):w("Diagnostic session "+this.session_id+" error : "+e.toString()):(null===(n=this.diagClient)||void 0===n?void 0:n.onData)?this.diagClient.onData(this,e):this.store(e),e.length}respond(e){this.messagesReceived.push(e),C()}close(){var e,t;return(null===(e=this.diagClient)||void 0===e?void 0:e.onClose)&&this.diagClient.onClose(this.messagesToSend),(null===(t=this.diagClient)||void 0===t?void 0:t.onClosePromise)&&this.diagClient.onClosePromise.resolve(this.messagesToSend),0===this.messagesToSend.length||(this.diagClient&&!this.diagClient.skipDownload&&function(e){const t=new Blob(e,{type:"application/octet-stream"}),s=URL.createObjectURL(t),n=document.createElement("a");n.download="trace."+(new Date).valueOf()+".nettrace",function(e,...t){console.info(v+e,...t)}(`Downloading trace ${n.download} - ${t.size}  bytes`),n.href=s,document.body.appendChild(n),n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}(this.messagesToSend),this.messagesToSend=[]),0}}function U(){S=n.createPromiseController()}function B(e){if(S.promise_control.isDone)throw new Error("multiple clients in parallel are not allowed");S.promise_control.resolve(e)}function P(e,t){return new L(e,t)}class L extends b{constructor(e,t){super(e);const s=this.ws=new WebSocket(t),n=async e=>{const t=await e.data.arrayBuffer(),s=new Uint8Array(t);this.messagesReceived.push(s),y()};s.addEventListener("open",(()=>{for(const e of this.messagesToSend)s.send(e);this.messagesToSend=[],y()}),{once:!0}),s.addEventListener("message",n),s.addEventListener("error",(()=>{w("Diagnostic server WebSocket connection was closed unexpectedly."),s.removeEventListener("message",n)}),{once:!0})}send(e){return C(),this.ws.readyState==WebSocket.CLOSED?-1:this.ws.readyState==WebSocket.CONNECTING?super.store(e):(this.ws.send(e),e.length)}close(){return C(),this.ws.close(),0}}let N,W=1;function x(r){!function(r){if(e)throw new Error("Diag module already loaded");e=!0,t=r.diagnosticHelpers,s=r.runtimeHelpers,n=r.loaderHelpers,o=r.module}(r),t.ds_rt_websocket_create=e=>{T||(T=new Map);const t=null!=N?N:s.utf8ToString(e),n=W++,o=t.startsWith("ws://")||t.startsWith("wss://")?P(n,t):function(e,t){if(!R){R=!0,t.startsWith("js://gcdump")&&D({}),t.startsWith("js://counters")&&A({}),t.startsWith("js://cpu-samples")&&k({});const e=globalThis.dotnetDiagnosticClient;"function"==typeof e&&S.promise_control.resolve(e(t))}return new M(e)}(n,t);return T.set(n,o),n},t.ds_rt_websocket_send=(e,t,s)=>{const n=T.get(e);if(!n)return-1;const r=new Uint8Array(o.HEAPU8.buffer,t,s).slice();return n.send(r)},t.ds_rt_websocket_poll=e=>{const t=T.get(e);return t?t.poll():0},t.ds_rt_websocket_recv=(e,t,s)=>{const n=T.get(e);return n?n.recv(t,s):-1},t.ds_rt_websocket_close=e=>{const t=T.get(e);return t?(T.delete(e),t.close()):-1},r.api.collectCpuSamples=k,r.api.collectMetrics=A,r.api.collectGcDump=D,r.api.connectDSRouter=O,U()}function O(e){if(!E)throw new Error("No active session to reconnect");N=e;const t=P(E.client_socket,e);T.set(E.client_socket,t),t.send(function(){const e=new Uint8Array(16);globalThis.crypto.getRandomValues(e),e[7]=15&e[7]|64;const t=s.mono_wasm_process_current_pid();return Uint8Array.from([...r,...e,...m([0,t]),0,0])}())}export{x as setRuntimeGlobals};
//# sourceMappingURL=dotnet.diagnostics.js.map
